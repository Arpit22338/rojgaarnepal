generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String
  role          String    @default("JOBSEEKER")
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  jobSeekerProfile JobSeekerProfile?
  employerProfile  EmployerProfile?
  jobs             Job[]             @relation("EmployerJobs")
  applications     Application[]
  enrollments      Enrollment[]
  
  // New Features
  isVerified       Boolean   @default(false)
  isPremium        Boolean   @default(false)
  premiumExpiresAt DateTime?
  jobLimit         Int       @default(2)
  talentLimit      Int       @default(1)
  isBanned         Boolean   @default(false)
  verificationDoc  String?
  otp              String?
  otpExpires       DateTime?
  
  // New User Fields
  phoneNumber      String?
  lastActivityAt   DateTime?
  isMegaPremium    Boolean   @default(false)
  megaPremiumUntil DateTime?
  qrCodeUrl        String?   // For teachers

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  talentPosts      TalentPost[]
  
  questions        Question[]
  answers          Answer[]
  notifications    Notification[]
  givenTrusts      Trust[]   @relation("GivenTrusts")
  receivedTrusts   Trust[]   @relation("ReceivedTrusts")
  savedJobs        SavedJob[]
  reportsMade      Report[]  @relation("Reporter")
  reportsReceived  Report[]  @relation("ReportedUser")
  premiumRequests  PremiumRequest[]
  supportTickets   SupportTicket[]
  
  // Teacher & Course Features
  teacherActivationRequests TeacherActivationRequest[]
  kycRecords                KycRecord[]
  courses                   Course[]
  pushSubscriptions         PushSubscription[]
  certificates              Certificate[]
}

model TempRegistration {
  id         String   @id @default(cuid())
  email      String   @unique
  otp        String
  otpExpires DateTime
  data       String   // JSON string of user data
  createdAt  DateTime @default(now())
}

model PremiumRequest {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planType      String
  amount        Float
  screenshotUrl String
  phoneNumber   String?
  whatsappNumber String?
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Report {
  id        String   @id @default(cuid())
  reporterId String
  reporter  User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  
  targetJobId String?
  targetJob   Job?     @relation(fields: [targetJobId], references: [id], onDelete: Cascade)
  
  targetUserId String?
  targetUser   User?   @relation("ReportedUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  reason    String
  description String?
  screenshotUrl String?
  status    String   @default("PENDING") // PENDING, RESOLVED, DISMISSED
  createdAt DateTime @default(now())
}

model SavedJob {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, jobId])
}

model Message {
  id        String   @id @default(cuid())
  content   String
  senderId  String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model TalentPost {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  bio         String
  skills      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobSeekerProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio         String?
  skills      String?  // Comma separated or JSON
  resumeUrl   String?
  portfolioUrl String?
  location    String?
  experience  String?
  education   String?
}

model EmployerProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String
  description String?
  website     String?
  portfolioUrl String?
  location    String?
  logoUrl     String?
}

model Job {
  id          String        @id @default(cuid())
  title       String
  description String
  location    String
  salary      String?
  salaryMin   Int?
  salaryMax   Int?
  isFeatured  Boolean       @default(false)
  isPremium   Boolean       @default(false)
  type        String        // Full-time, Part-time, etc.
  employerId  String
  employer    User          @relation("EmployerJobs", fields: [employerId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  expiresAt   DateTime?
  views       Int           @default(0)
  applications Application[]
  savedByUsers SavedJob[]
  reports      Report[]
  
  // For recommendations
  requiredSkills String?
  
  questions    Question[]
}

model Question {
  id        String   @id @default(cuid())
  content   String
  // answer    String? // Deprecated in favor of Answer model
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  answers   Answer[]
}

model Answer {
  id         String   @id @default(cuid())
  content    String
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  type      String   @default("INFO") // message, applicationStatus, etc.
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
}

model Trust {
  id        String   @id @default(cuid())
  trusterId String
  truster   User     @relation("GivenTrusts", fields: [trusterId], references: [id], onDelete: Cascade)
  trustedId String
  trusted   User     @relation("ReceivedTrusts", fields: [trustedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([trusterId, trustedId])
}

model Application {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("PENDING") // PENDING, REVIEWING, ACCEPTED, REJECTED
  coverLetter String?
  createdAt DateTime @default(now())
}

model Course {
  id                   String       @id @default(cuid())
  
  // New fields (Optional to avoid reset)
  teacherId            String?
  teacher              User?        @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  title                String
  description          String
  
  // Old fields (Keep to avoid data loss)
  price                Float?
  instructor           String?
  duration             String?
  thumbnail            String?

  // New fields
  thumbnailUrl         String?
  qrCodeUrl            String?   // Specific QR for this course
  totalRequiredMinutes Int          @default(0)
  priceNpr             Float?
  isPublished          Boolean      @default(false)
  isAdminOwned         Boolean      @default(false)
  editCount            Int          @default(0)
  
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt @default(now())
  
  lessons              Lesson[]
  enrollments          Enrollment[]
  certificates         Certificate[]
}

model Lesson {
  id          String         @id @default(cuid())
  courseId    String
  course      Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  content     String
  youtubeUrl  String?
  orderIndex  Int
  quizQuestions QuizQuestion[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model QuizQuestion {
  id            String   @id @default(cuid())
  lessonId      String
  lesson        Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questionText  String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctOption String   // A, B, C, D
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Enrollment {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId              String
  course                Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  status                String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  
  // Old fields
  progress              Int      @default(0)

  // New fields
  paymentScreenshotUrl  String?
  paymentPhone          String?
  timeSpentMinutes      Int      @default(0)
  hasCompletedFirstQuiz Boolean  @default(false)
  finalScore            Float    @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt @default(now())
  quizResults           QuizResult[]

  @@unique([courseId, userId])
}

model QuizResult {
  id           String   @id @default(cuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId     String
  score        Float
  completedAt  DateTime @default(now())
}

model Certificate {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId       String
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  score          Float
  certificateUrl String
  issuedAt       DateTime @default(now())
}

model TeacherActivationRequest {
  id                 String   @id @default(cuid())
  teacherId          String
  teacher            User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  paymentPhone       String
  paymentScreenshotUrl String
  status             String   @default("PENDING") // PENDING, APPROVED, REJECTED
  adminNote          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model KycRecord {
  id            String   @id @default(cuid())
  teacherId     String
  teacher       User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  documentType  String   // citizenship, passport, national_id
  frontImageUrl String
  backImageUrl  String
  faceImageUrl  String?  // Full face image for teacher authenticity verification (optional)
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  adminNote     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
}

model SupportTicket {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject   String
  message   String
  reply     String?
  status    String   @default("OPEN") // OPEN, CLOSED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
